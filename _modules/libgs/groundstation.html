

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>libgs.groundstation &mdash; libgs  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> libgs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.utils.html">libgs.utils</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.scheduler.html">libgs.scheduler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.rpc.html">libgs.rpc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.restapi.html">libgs.restapi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.hardware.html">libgs.hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.groundstation.html">libgs.groundstation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.console_scripts.html">libgs entrypoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.visualisation.html">libgs.visualisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.database.html">libgs.database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.emulators.html">libgs.emulators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.monitoring.html">libgs.monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../_autosummary/libgs.protocols.protocolbase.html">libgs.protocols.protocolbase</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">libgs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>libgs.groundstation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for libgs.groundstation</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">..</span>
<span class="sd">    Copyright Â© 2017-2018 The University of New South Wales</span>

<span class="sd">    Permission is hereby granted, free of charge, to any person obtaining a copy of</span>
<span class="sd">    this software and associated documentation files (the &quot;Software&quot;), to deal in</span>
<span class="sd">    the Software without restriction, including without limitation the rights to use,</span>
<span class="sd">    copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the</span>
<span class="sd">    Software, and to permit persons to whom the Software is furnished to do so,</span>
<span class="sd">    subject to the following conditions:</span>

<span class="sd">    The above copyright notice and this permission notice shall be included in all</span>
<span class="sd">    copies or substantial portions of the Software.</span>

<span class="sd">    THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class="sd">    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class="sd">    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class="sd">    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span>
<span class="sd">    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN</span>
<span class="sd">    CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="sd">    Except as contained in this notice, the name or trademarks of a copyright holder</span>

<span class="sd">    shall not be used in advertising or otherwise to promote the sale, use or other</span>
<span class="sd">    dealings in this Software without prior written authorization of the copyright</span>
<span class="sd">    holder.</span>

<span class="sd">    UNSW is a trademark of The University of New South Wales.</span>


<span class="sd">libgs.groundstation</span>
<span class="sd">====================</span>

<span class="sd">:date:   Thu May 25 14:08:34 2017</span>
<span class="sd">:author: Kjetil Wormnes</span>

<span class="sd">This implements the main GroundStation class. It derives from :class:`GroundStationbase` as it is conceivable that a different type of</span>
<span class="sd">implementation would be desired. In general, however, most implementation of Ground Stations will want to derive from the :class:`GroundStation`</span>
<span class="sd">class and just overload the methods that are needed.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">ephem</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="k">import</span> <span class="n">pi</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="k">import</span> <span class="n">DataFrame</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">angles</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">rpc</span> <span class="k">import</span> <span class="n">RPCServer</span>


<span class="kn">from</span> <span class="nn">utils</span> <span class="k">import</span> <span class="n">Error</span><span class="p">,</span> <span class="n">RegularCallback</span><span class="p">,</span> <span class="n">Defaults</span><span class="p">,</span> <span class="n">wait_loop</span><span class="p">,</span> <span class="n">conv_time</span><span class="p">,</span> <span class="n">UTCLogFormatterHTML</span><span class="p">,</span> <span class="n">AbortAllException</span><span class="p">,</span> <span class="n">safe_sleep</span>
<span class="kn">from</span> <span class="nn">monitoring</span> <span class="k">import</span> <span class="n">Monitor</span>
<span class="kn">from</span> <span class="nn">protocols.protocolbase</span> <span class="k">import</span>  <span class="n">ProtocolBase</span>
<span class="kn">from</span> <span class="nn">propagator</span> <span class="k">import</span> <span class="n">Propagator</span>
<span class="kn">from</span> <span class="nn">hardware</span> <span class="k">import</span> <span class="n">RotatorBase</span><span class="p">,</span> <span class="n">RadioBase</span><span class="p">,</span> <span class="n">DummyRotator</span>
<span class="kn">from</span> <span class="nn">database</span> <span class="k">import</span> <span class="n">CommsLog</span><span class="p">,</span> <span class="n">PassDb</span>




<span class="c1">#</span>
<span class="c1"># Configure logging</span>
<span class="c1">#</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;libgs-log&#39;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">NullHandler</span><span class="p">())</span>


<span class="k">try</span><span class="p">:</span>
    <span class="c1">#### For plotting</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">io</span>
    <span class="n">_HAS_MPL</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">_HAS_MPL</span> <span class="o">=</span> <span class="kc">False</span>




<span class="k">def</span> <span class="nf">_mpl_make_waterfall_jpg</span><span class="p">(</span><span class="n">radios</span><span class="p">,</span> <span class="n">recordings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to create a waterfall plot to store in the databases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#</span>
    <span class="c1"># Convert recorded spectra to images.</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_HAS_MPL</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Cannot create waterfall - missing packages. Install matplot + pillow to make this work&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>        

    <span class="n">dpi</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">WFALL_JPG_DPI</span>
    <span class="n">fig_h</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">WFALL_JPG_HEIGHT</span>
    <span class="n">fig_w</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">WFALL_JPG_WIDTH_EXTRA</span> <span class="o">+</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">WFALL_JPG_WIDTH</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">recordings</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">fig_w</span><span class="o">/</span><span class="n">dpi</span><span class="p">,</span> <span class="n">fig_h</span><span class="o">/</span><span class="n">dpi</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
    <span class="n">left_a</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">radrec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">recordings</span><span class="p">):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">radios</span><span class="p">),</span> <span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">radios</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">left_a</span> <span class="o">=</span> <span class="n">a</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">fv</span><span class="p">,</span><span class="n">dv</span><span class="p">,</span><span class="n">sp</span> <span class="o">=</span> <span class="n">radrec</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">a</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labeltop</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelleft</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">labelright</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">continue</span>
        
        <span class="c1"># Get the bad specra (all zeroes)</span>
        <span class="n">bad_spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">sp</span><span class="p">[</span><span class="n">bad_spec</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">minval</span>

        <span class="n">f0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fv</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">((</span><span class="n">fv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">f0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">fv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">f0</span><span class="p">)</span><span class="o">*</span><span class="mi">1000</span><span class="p">,</span> <span class="p">(</span><span class="n">dv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">WFALL_JPG_COLORMAP</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s2">&quot;auto&quot;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s2">&quot;box&quot;</span><span class="p">)</span>
        <span class="n">a</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (kHz + </span><span class="si">{:.0f}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f0</span><span class="o">*</span><span class="mi">1000</span><span class="p">))</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Radio </span><span class="si">{}</span><span class="s2">. </span><span class="si">{}</span><span class="s2"> spectra recorded&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">radios</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">sp</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="c1"># Leftmost plot should have a ylabel indicating the start of the pass</span>
    <span class="k">if</span> <span class="n">left_a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">left_a</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time (sec + </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conv_time</span><span class="p">(</span><span class="n">dv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">to</span><span class="o">=</span><span class="s2">&quot;datetime&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S Z&#39;</span><span class="p">)))</span>

    <span class="n">buf</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;jpg&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="o">/</span><span class="n">Defaults</span><span class="o">.</span><span class="n">WFALL_JPG_OUT_SCALE</span><span class="p">)</span>
    <span class="n">image_data</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">buf</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
    <span class="n">buf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">image_data</span>




<div class="viewcode-block" id="GroundStationBase"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.html#libgs.groundstation.GroundStationBase">[docs]</a><span class="k">class</span> <span class="nc">GroundStationBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for ground stations.</span>
<span class="sd">    </span>
<span class="sd">    If implementing a new GroundStation class, derive from this class and overload as a minimum the interface methods:</span>

<span class="sd">    * :meth:`.transmit`</span>
<span class="sd">    * :meth:`.do_action`</span>
<span class="sd">    * :meth:`.set_rangerate`</span>
<span class="sd">    * :meth:`.track`</span>

<span class="sd">    .. note::</span>
<span class="sd">       do_action, set_rangerate and transmit are implemented in :class:`GroundStation` as simple wrappers with some logging</span>
<span class="sd">       of the respective methods :meth:`.protocols.protocolbase.ProtocolBase.send_bytes`, :meth:`.protocols.protocolbase.ProtocolBase.do_action`,</span>
<span class="sd">       :meth:`.hardware.RadioBase.set_range_rate`. </span>

<span class="sd">       .. warning::</span>
<span class="sd">          In the future these interface methods are likely to be merged into this base class instead, and will no longer require overloading </span>
<span class="sd">          in new implementations.</span>

<span class="sd">    The following methods can be overloaded if the functionality is required:</span>

<span class="sd">    * :meth:`.power_up`</span>
<span class="sd">    * :meth:`.power_down`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1">#: The time interval at  which to run the monitor callback while tracking</span>
    <span class="n">MONITOR_SAVE_DT_TRACK</span>   <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">MONITOR_SAVE_DT_TRACK</span>

    <span class="c1">#: The time interval at which to run the monitor callback when not tracking</span>
    <span class="n">MONITOR_SAVE_DT_NOTRACK</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">MONITOR_SAVE_DT_NOTRACK</span>

    
    <span class="c1">############################</span>
    <span class="c1">#</span>
    <span class="c1"># Properties</span>
    <span class="c1">#</span>
    <span class="c1">############################</span>
    <span class="n">_radios</span>    <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_rotators</span>  <span class="o">=</span> <span class="p">[]</span>
    <span class="n">_protocol</span>  <span class="o">=</span> <span class="kc">None</span>
    <span class="n">_propagator</span><span class="o">=</span> <span class="kc">None</span>
    

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radios</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">r</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotators</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">r</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">radios</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of radios (see :class:`~.hardware.RadioBase` ) that are installed on the groundstation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_radios</span>
    
    <span class="nd">@radios</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">radios</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;radios must be a list of Radio objects, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">RadioBase</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;radios must be a list of Radio objects, got a </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">rr</span><span class="p">)))</span>
      
        <span class="bp">self</span><span class="o">.</span><span class="n">_radios</span> <span class="o">=</span> <span class="n">r</span>      
      
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rotators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of rotators (see :class:`~.hardware.RotatorBase` ) that are installed on the groundstation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rotators</span>
    
    <span class="nd">@rotators</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rotators</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">r</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;rotators must be a list of Rotator objects, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">r</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">RotatorBase</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;rotators must be a list of Rotator objects, got a </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">rr</span><span class="p">)))</span>          
        <span class="bp">self</span><span class="o">.</span><span class="n">_rotators</span> <span class="o">=</span> <span class="n">r</span>
        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of protocols (see :class:`~.protocols.protocolbase.ProtocolBase` ) that are installed on the groundstation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span>
        
    <span class="nd">@protocols</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">protocols</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;protocols must be a list of Protocol objects, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        
        <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">ProtocolBase</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;protocol is of invalid type, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span> <span class="o">=</span> <span class="n">p</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Property to set/get the current protocol. When setting you can use the :attr:`~.protocols.protocolbase.ProtocolBase.name` attribute</span>
<span class="sd">        of the protocol, or its instance. To use the name syntax it must already be installed (exist in the :attr:`.protocols` list).</span>

<span class="sd">        Examples:</span>

<span class="sd">        &gt;&gt;&gt; gs.protocols = [MyFavoriteProtocol(name=&#39;a_protocol&#39;), MyOtherProtocol(name=&#39;other_protocol&#39;)]</span>
<span class="sd">        &gt;&gt;&gt; gs.protocol = &#39;a_protocol&#39;</span>

<span class="sd">        or you can directly assign a protocol:</span>

<span class="sd">        &gt;&gt;&gt; gs.protocol = MyFavoriteProtocol()</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span>
        
    <span class="nd">@protocol</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">protocol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="n">bad_input</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ProtocolBase</span><span class="p">):</span>
                <span class="n">bad_input</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">p</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_protocols</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">p1</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">p</span><span class="p">:</span>
                        <span class="n">bad_input</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span> <span class="o">=</span> <span class="n">p1</span>

            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Protocol has been set to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_protocol</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bad_input</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;protocol must be a valid Protocol class or a string in &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="o">%</span><span class="p">([</span><span class="n">pp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="p">]))</span>


        
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">propagator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set / Get a propagator. This is not necessary, but if installed it will permit you to call :meth:`track` with just a norad ID</span>
<span class="sd">        rather than the full az/el schedule.        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span>
        
    <span class="nd">@propagator</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">propagator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Propagator</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;propagator is of invalid type, got </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">_propagator</span> <span class="o">=</span> <span class="n">p</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set / Get a :class:`~.monitoring.Monitor`. If a monitor is associated this way with the GroundStation, the values will be stored</span>
<span class="sd">        in the :class:`~.database.MonitorDb` database. The rate at which this is saved is set with :attr:`.MONITOR_SAVE_DT_TRACK` </span>
<span class="sd">        and :attr:`.MONITOR_SAVE_DT_NOTRACK`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_monitor&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
            
    <span class="nd">@monitor</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Monitor</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Error setting monitor, expected object of type Monitor, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">m</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span> <span class="o">=</span> <span class="n">m</span>
            <span class="c1"># self._monitor_logger = IntervalCallback(self._monitor_logger_cb, dt = self.MONITOR_SAVE_DT_NOTRACK)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_cb</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rpcserver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assign an :class:`~.rpc.RPCServer` to the Ground Station if you want to be able to call its methods remotely</span>
<span class="sd">        over XMLRPC.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_rpcserver&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@rpcserver</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rpcserver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">RPCServer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Error setting rpcserver, expected object of type RPCServer, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span> <span class="o">=</span> <span class="n">s</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="k">lambda</span> <span class="n">prot</span><span class="p">,</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">:</span> <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;protocol&#39;</span><span class="p">,</span>  <span class="n">prot</span><span class="p">),</span> <span class="s2">&quot;set_protocol&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_track</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stop_track</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">do_action</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_azel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stow</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transmit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_rx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_rxtx</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_azel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_rpcserver</span><span class="o">.</span><span class="n">register_introspection_functions</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Registered RPC interface to ground station on </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">uri</span><span class="p">))</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The currently associated :class:`~.scheduler.Scheduler`. This ensures that multiple schedulers will not be competing for</span>
<span class="sd">        the GroundStation&#39;s attention.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_scheduler&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@scheduler</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">scheduler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sch</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;groundstation.scheduler: Cannot attach a new scheduler to groundstation since the state is currently not IDLE. It is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_scheduler</span> <span class="o">=</span> <span class="n">sch</span>




    <span class="c1">######################</span>
    <span class="c1">#</span>
    <span class="c1"># Methods</span>
    <span class="c1">#</span>
    <span class="c1">######################</span>

<div class="viewcode-block" id="GroundStationBase.start_track"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.start_track.html#libgs.groundstation.GroundStationBase.start_track">[docs]</a>    <span class="k">def</span> <span class="nf">start_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid_or_pdata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Non-blocking tracking. The antenna will be pointed as</span>
<span class="sd">            required but returning control while doing so.</span>

<span class="sd">            It is implemented by spinning the track function off into a separate thread</span>

<span class="sd">            Args:</span>
<span class="sd">                nid_or_pdata (int or DataFrame) : The norad ID (if a :attr:`.propagator` is installed, or a pass data DataFrame)</span>
<span class="sd">                **kwargs: Any other argument to pass to :meth:`.track`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_pthr_track</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">nid_or_pdata</span><span class="p">,),</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pthr_track</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroundStationBase.stop_track"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.stop_track.html#libgs.groundstation.GroundStationBase.stop_track">[docs]</a>    <span class="k">def</span> <span class="nf">stop_track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Stop tracking satellite.</span>

<span class="sd">            Args:</span>
<span class="sd">                block (bool)    : If true, wait for trakcing thread to join before exiting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_track</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stop_track has already been called. Not doing anything.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="c1">#&lt;-- dont do it twice</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_track</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pthr_track</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>
            

<div class="viewcode-block" id="GroundStationBase.terminate"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.terminate.html#libgs.groundstation.GroundStationBase.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for :meth:`.protocols.protocolbase.ProtocolBase.terminate`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span> <span class="p">(</span><span class="s2">&quot;Error: groundstation.terminate. No protocol have been connected to Ground Station.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroundStationBase.init_rx"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.init_rx.html#libgs.groundstation.GroundStationBase.init_rx">[docs]</a>    <span class="k">def</span> <span class="nf">init_rx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for :meth:`.protocols.protocolbase.ProtocolBase.init_rx`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Error: groundstation.init_rx. No protocol have been connected to Ground Station.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">init_rx</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroundStationBase.init_rxtx"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.init_rxtx.html#libgs.groundstation.GroundStationBase.init_rxtx">[docs]</a>    <span class="k">def</span> <span class="nf">init_rxtx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper for :meth:`.protocols.protocolbase.ProtocolBase.init_rxtx`</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span> <span class="p">(</span><span class="s2">&quot;Error: groundstation.init_rxtx. No protocol have been connected to Ground Station.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">init_rxtx</span><span class="p">()</span></div>

<div class="viewcode-block" id="GroundStationBase.get_azel"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.get_azel.html#libgs.groundstation.GroundStationBase.get_azel">[docs]</a>    <span class="k">def</span> <span class="nf">get_azel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loop through the installed :attr:`.rotators` and return a list of az/el positions by querying each</span>
<span class="sd">        individual rotator&#39;s :meth:`~.hardware.RotatorBase.get_azel` method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span> <span class="p">(</span><span class="s2">&quot;Error: groundstation.get_azel. No rotators have been connected to Ground Station.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">get_azel</span><span class="p">()])</span>

        <span class="k">return</span> <span class="n">result</span></div>
            
<div class="viewcode-block" id="GroundStationBase.set_azel"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.set_azel.html#libgs.groundstation.GroundStationBase.set_azel">[docs]</a>    <span class="k">def</span> <span class="nf">set_azel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the az/el pointing for each installed :attr:`.rotators`</span>

<span class="sd">        Args:</span>
<span class="sd">            az (float) : Azimuth angle</span>
<span class="sd">            el (float) : Elevation angle</span>
<span class="sd">            block (bool (optional)): If true, wait for antennas to be in position before returning.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;GroundStation.set_azel called but no rotators available&quot;</span><span class="p">)</span>
        
        <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">60</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">set_azel</span><span class="p">(</span><span class="n">az</span><span class="p">,</span><span class="n">el</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">SLEW_TIMEOUT</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">SLEW_TIMEOUT</span> <span class="o">&gt;</span> <span class="n">TIMEOUT</span> <span class="k">else</span> <span class="n">TIMEOUT</span>
            
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">wait_loop</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">all</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">in_pos</span><span class="p">(</span><span class="n">az</span><span class="p">,</span> <span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">]),</span> <span class="n">timeout</span><span class="o">=</span><span class="n">TIMEOUT</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout (</span><span class="si">{}</span><span class="s2"> sec) waiting for rotators to position themselves&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">TIMEOUT</span><span class="p">))</span></div>


<div class="viewcode-block" id="GroundStationBase.stow"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.stow.html#libgs.groundstation.GroundStationBase.stow">[docs]</a>    <span class="k">def</span> <span class="nf">stow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stow all installed :attr:`rotators`. The position the rotators are stowed in is set in the :attr:`.hardware.RotatorBase.STOWED_AZ`</span>
<span class="sd">        and :attr:`.hardware.RotatorBase.STOWED_EL` attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;GroundStation.stow called but no rotators available&quot;</span><span class="p">)</span>
        
        <span class="n">TIMEOUT</span> <span class="o">=</span> <span class="mi">60</span>
        
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">:</span>
            <span class="n">r</span><span class="o">.</span><span class="n">stow</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            
            <span class="k">while</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">in_pos</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">STOWED_AZ</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">STOWED_EL</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">]):</span>
                
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">TIMEOUT</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Timeout waiting for rotators to position themselves&quot;</span><span class="p">)</span>
                    <span class="k">break</span></div>
            


    <span class="c1">############################</span>
    <span class="c1">#</span>
    <span class="c1"># Interface methods (shall be overloaded)</span>
    <span class="c1">#</span>
    <span class="c1">############################</span>
    
<div class="viewcode-block" id="GroundStationBase.set_rangerate"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.set_rangerate.html#libgs.groundstation.GroundStationBase.set_rangerate">[docs]</a>    <span class="k">def</span> <span class="nf">set_rangerate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_rate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the range_rate for all installed radios.</span>
<span class="sd">        Should normally be a wrapper for :meth:`.hardware.RadioBase.set_range_rate`</span>

<span class="sd">        Args:</span>
<span class="sd">            range_rate (float): The range rate (in m/s)        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;GroundStation.set_rangerate interface not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroundStationBase.transmit"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.transmit.html#libgs.groundstation.GroundStationBase.transmit">[docs]</a>    <span class="k">def</span> <span class="nf">transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">TX_REPLY_TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send bytes to satellite</span>
<span class="sd">        Should normally be a wrapper for :meth:`.protocols.protocolbase.ProtocolBase.send_bytes`   </span>

<span class="sd">        Args:</span>
<span class="sd">            msg (bytearray):    The bytes to send     </span>
<span class="sd">            wait (int):         Number of seconds to wait for task to complete</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;GroundStation.transmit interface not implemented&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroundStationBase.track"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.track.html#libgs.groundstation.GroundStationBase.track">[docs]</a>    <span class="k">def</span> <span class="nf">track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid_or_pdata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Track satellite</span>

<span class="sd">        Args:</span>
<span class="sd">            nid_or_pdata (int or DataFrame) : The norad ID (if a :attr:`.propagator` is installed, or a pass data DataFrame)</span>
<span class="sd">            **kwargs: Any other arguments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;GroundStation.track interface not implemented&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GroundStationBase.do_action"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.do_action.html#libgs.groundstation.GroundStationBase.do_action">[docs]</a>    <span class="k">def</span> <span class="nf">do_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an :class:`~libgs_ops.scheduling.Action`.</span>
<span class="sd">        Should normally be a wrapper for :meth:`.protocols.protocolbase.ProtocolBase.do_action`</span>

<span class="sd">        Args:</span>
<span class="sd">            desc (str): Description of the action</span>
<span class="sd">            *args     : Arguments to pass to :meth:`.protocols.protocolbase.ProtocolBase.do_action`</span>
<span class="sd">            **kwargs  : KW Arguments to pass to :meth:`.protocols.protocolbase.ProtocolBase.do_action`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;GroundStation.do_action interface&quot;</span><span class="p">)</span></div>
        
        
    <span class="c1">##############################</span>
    <span class="c1">#</span>
    <span class="c1"># Interface methos (may be overloaded)</span>
    <span class="c1">#</span>
    <span class="c1">##############################</span>
<div class="viewcode-block" id="GroundStationBase.power_up"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.power_up.html#libgs.groundstation.GroundStationBase.power_up">[docs]</a>    <span class="k">def</span> <span class="nf">power_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when class initialises and can be overloaded to perform tasks such as powering on amplifiers etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Nothing is being powered on by ground station since the power_up interface has not been defined&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="GroundStationBase.power_down"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStationBase.power_down.html#libgs.groundstation.GroundStationBase.power_down">[docs]</a>    <span class="k">def</span> <span class="nf">power_down</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when class destroys and can be overloaded to perform tasks such as powering down amplifiers etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Nothing is being powered down by ground station since the power_down interface has not been defined&quot;</span><span class="p">)</span></div></div>



<div class="viewcode-block" id="UILogHandler"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.UILogHandler.html#libgs.groundstation.UILogHandler">[docs]</a><span class="k">class</span> <span class="nc">UILogHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A custom :class:`logging.Handler` that can be used to log to :attr:`.GSState.libgs_log`</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gsstate</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stateinstance</span> <span class="o">=</span> <span class="n">gsstate</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">UILogHandler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>


<div class="viewcode-block" id="UILogHandler.emit"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.UILogHandler.emit.html#libgs.groundstation.UILogHandler.emit">[docs]</a>    <span class="k">def</span> <span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_stateinstance</span><span class="o">.</span><span class="n">libgs_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">record</span><span class="p">)</span></div>


<div class="viewcode-block" id="UILogHandler.test"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.UILogHandler.test.html#libgs.groundstation.UILogHandler.test">[docs]</a>    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stateinstance</span><span class="o">.</span><span class="n">libgs_log</span> <span class="o">=</span> <span class="n">m</span></div></div>
        
        
<span class="c1"># TODO: Review GSState and which part of it to keep in libgs and which to</span>
<span class="c1">#       move to adfags. </span>
<span class="c1">#       It also includes a bunch of stuff that isnt needed anymore which would</span>
<span class="c1">#       be good to get rid of</span>
<div class="viewcode-block" id="GSState"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GSState.html#libgs.groundstation.GSState">[docs]</a><span class="k">class</span> <span class="nc">GSState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to hold ground station state variables.</span>

<span class="sd">    The ground station uses this class to store important state variables,</span>
<span class="sd">    (as its properties). The class does however have the ability to connect</span>
<span class="sd">    callbacks to those properites in order to, for example, update a UI.</span>

<span class="sd">    Makes use of python properties to ensure the callbacks. It is also possible to assign states to be polled</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#</span>
    <span class="c1"># Tracking states</span>
    <span class="c1">#</span>
    <span class="n">IDLE</span> <span class="o">=</span> <span class="s1">&#39;idle&#39;</span>           <span class="c1">#: See :attr:`.state`</span>
    <span class="n">SLEWING</span> <span class="o">=</span> <span class="s1">&#39;slewing&#39;</span>     <span class="c1">#: See :attr:`.state`</span>
    <span class="n">WAITING</span> <span class="o">=</span> <span class="s1">&#39;waiting&#39;</span>     <span class="c1">#: See :attr:`.state`</span>
    <span class="n">TRACKING</span> <span class="o">=</span> <span class="s1">&#39;tracking&#39;</span>   <span class="c1">#: See :attr:`.state`</span>

    <span class="c1">#: The logging handler that is used for adding log messages to ui</span>
    <span class="n">uiloghandler</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callbacks</span><span class="o">=</span><span class="p">{},</span> <span class="n">callback_dt</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">pollmap</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            callbacks (dict):   A dictionary of callbacks to invoke upon setting state variables</span>
<span class="sd">            callback_dt (dict): A dictionary of minimum time intervals between subsequent invokations of the callbacks</span>
<span class="sd">            pollmap (dict):     A dictionary of state variables to poll using the designated polling functions (instead of callback)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialise all the properties</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curpos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmdpos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_satpos</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nid</span>    <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pdat</span>   <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>  <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_libgs_log</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_POLL_INTERVAL</span> <span class="o">=</span> <span class="mf">10.0</span> <span class="c1">#&lt;--- seconds between each poll of polled state variables</span>

        <span class="c1">#</span>
        <span class="c1"># Initialise logging to the state variable</span>
        <span class="c1">#</span>
        <span class="n">ch</span> <span class="o">=</span> <span class="n">UILogHandler</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="n">UTCLogFormatterHTML</span><span class="p">(</span><span class="n">Defaults</span><span class="o">.</span><span class="n">LOG_FORMAT</span><span class="p">)</span>
        <span class="n">ch</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;libgs_ops-log&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="c1">#&lt;-- also show libgs_ops output</span>

        <span class="c1"># Make available as a property so that it can be</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uiloghandler</span> <span class="o">=</span> <span class="n">ch</span>

        <span class="c1">#</span>
        <span class="c1"># The map of functions to poll to set state attributes</span>
        <span class="c1"># (in most cases teh ground station will set them directly and</span>
        <span class="c1"># therefore the poller is not necessary)</span>
        <span class="c1"># The state can be updated through polling for items that do not set</span>
        <span class="c1"># it directly. The polling functions are specified as a dict where</span>
        <span class="c1"># the key is the state attribute to update, and the value is the function</span>
        <span class="c1"># to call to update it.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pollmap</span> <span class="o">=</span> <span class="n">pollmap</span>

        <span class="c1"># TODO: Replace this with a RegularCallback (or at least by a wait_loop)</span>
        <span class="k">def</span> <span class="nf">_poller</span><span class="p">():</span>
            <span class="k">while</span> <span class="p">(</span><span class="kc">True</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pollmap</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">())</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">wait_loop</span><span class="p">(</span><span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_POLL_INTERVAL</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">AbortAllException</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;gsstate._poller aborted with global abort_all event&quot;</span><span class="p">)</span>
                    <span class="k">return</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_pthr_poll</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">_poller</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pthr_poll</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pthr_poll</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


        <span class="c1"># The name of the class that is permitted to change properties</span>
        <span class="c1"># Attempting to change from anywhere else will fail.</span>
        <span class="c1"># To permit mutation from anywhere, delte this property</span>
        <span class="c1"># To disable from anywhere, set it to None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mutable</span> <span class="o">=</span> <span class="s1">&#39;GroundStation&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_called</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callback_dt</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">callbacks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;update_&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Callback keys must have the form update_funcname&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">callback_dt</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;update_&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Callback keys must have the form update_funcname&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>



    <span class="k">def</span> <span class="nf">_setter</span><span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">muting_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method generates a decorator that checks the input type</span>
<span class="sd">        when setting properties and calls the specified callback function,</span>
<span class="sd">        also specifying a maximum call frequency</span>

<span class="sd">        (specified with the callbacks property)</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">func_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                <span class="c1"># Check type (also allow None)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dtype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Argument to </span><span class="si">%s</span><span class="s2"> must be </span><span class="si">%s</span><span class="s2">, not </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">func_name</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

                <span class="c1"># Only allow mutation if called from the allowed class</span>
                <span class="c1"># (the groundstation)</span>

                <span class="k">if</span> <span class="n">muting_class</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_mutable&#39;</span><span class="p">):</span>
                    <span class="n">mutable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mutable</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mutable</span> <span class="o">=</span> <span class="n">muting_class</span>

                <span class="k">if</span> <span class="n">mutable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span><span class="c1">#hasattr(self, &#39;_mutable&#39;):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">calling_class</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">_getframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span><span class="o">.</span><span class="n">f_locals</span><span class="p">[</span><span class="s1">&#39;self&#39;</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">calling_class</span> <span class="o">!=</span> <span class="s1">&#39;GSState&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">calling_class</span> <span class="o">!=</span> <span class="n">mutable</span><span class="p">):</span><span class="c1">#self._mutable:</span>
                            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Changing properties is not permitted&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Changing properties is not permitted&quot;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">raise</span>



                <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;update_&#39;</span><span class="o">+</span><span class="n">func</span><span class="o">.</span><span class="n">func_name</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_dt</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">or</span>\
                        <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_called</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span> <span class="ow">or</span>\
                            <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_called</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">callback_dt</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">key</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_last_called</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">func_wrapper</span>

        <span class="k">return</span> <span class="n">decorator</span>


    <span class="c1"># def tracking_info():</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Return info about tracking state</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     pass</span>

    <span class="c1"># def hardware_info():</span>
    <span class="c1">#     pass</span>

    <span class="c1"># def antenna_info():</span>
    <span class="c1">#     pass</span>

    <span class="c1"># def service_info():</span>
    <span class="c1">#     pass</span>


    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Format a basic string to describe the state</span>

<span class="sd">        .. todo::</span>
<span class="sd">            Complete with hardware power states and other stuff...</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span>  <span class="s2">&quot;Ground Station state</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;=======================</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Antenna</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;-----------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Current state: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Commanded position(s):          </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmdpos</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;Current position(s):            </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curpos</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pdu&#39;</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;PDU</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;-----------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdu</span>


        <span class="k">return</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">curpos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of current antenna az,el positions, in same order as :attr:`.GroundStationBase.rotators`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curpos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cmdpos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of current commanded positions, in same order as :attr:`.GroundStationBase.rotators`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cmdpos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">satpos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current satellite position</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_satpos</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current tracking state. One of</span>
<span class="sd">        </span>
<span class="sd">        * :attr:`.IDLE`</span>
<span class="sd">        * :attr:`.SLEWING`</span>
<span class="sd">        * :attr:`.WAITING`</span>
<span class="sd">        * :attr:`.TRACKING`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pdat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Current pass data DataFrame.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdat</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Currently tracked Norad ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nid</span>

    <span class="c1"># TODO: Store entire schedule (not just text) in state and do not</span>
    <span class="c1">#       permit two scheduler to be started with same gs</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Textual representation of current schedule</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">track_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A human readable message about current tracking state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_track_msg</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">libgs_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The latest :attr:`.utils.Defaults.UI_LOG_LEN` entries in the libgs-log.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_libgs_log</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pdu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Depreacated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pdu</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_response</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The last received bytes from the satellite</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_response</span>

    <span class="nd">@last_response</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="n">basestring</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">last_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_response</span> <span class="o">=</span> <span class="n">msg</span>

    <span class="nd">@pdu</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="n">basestring</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pdu</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@libgs_log</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="n">basestring</span><span class="p">,</span> <span class="s1">&#39;UILogHandler&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">libgs_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_libgs_log</span> <span class="o">+=</span> <span class="p">[</span><span class="n">msg</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_libgs_log</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">UI_LOG_LEN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_libgs_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_libgs_log</span><span class="p">[</span><span class="o">-</span><span class="n">Defaults</span><span class="o">.</span><span class="n">UI_LOG_LEN</span><span class="p">:]</span>


    <span class="nd">@track_msg</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="n">basestring</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">track_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_track_msg</span> <span class="o">=</span> <span class="n">msg</span>


    <span class="nd">@schedule</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="n">basestring</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schedule</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@satpos</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="nb">tuple</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">satpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_satpos</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@cmdpos</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">cmdpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cmdpos</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@curpos</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">curpos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_curpos</span> <span class="o">=</span> <span class="n">value</span>

    <span class="nd">@state</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="n">basestring</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;idle&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pdat</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_nid</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="nd">@pdat</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">pdat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pdat</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pdat</span> <span class="o">=</span> <span class="n">pdat</span>

    <span class="nd">@nid</span><span class="o">.</span><span class="n">setter</span>
    <span class="nd">@_setter</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">nid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nid</span> <span class="o">=</span> <span class="n">nid</span></div>



        
<div class="viewcode-block" id="GroundStation"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStation.html#libgs.groundstation.GroundStation">[docs]</a><span class="k">class</span> <span class="nc">GroundStation</span><span class="p">(</span><span class="n">GroundStationBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main class for the Ground Station</span>

<span class="sd">        Performs the function of interfacing with the hardware and user and ensuring everything is logged appropriately. It is built</span>
<span class="sd">        by deriving from :class:`GroundStationBase`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="c1">#: Whether to record spectra while tracking and attempt to create a waterfall plot at end of pass</span>
    <span class="n">RECORD_SPECTRA</span>         <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">RECORD_SPECTRA</span>

    <span class="c1">#: If :attr:`RECORD_SPECTRA` is True, sets the maximum number of spectra to record.</span>
    <span class="n">RECORD_SPECTRA_MAX_LEN</span> <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">RECORD_SPECTRA_MAX_LEN</span>

    <span class="c1">#: If :attr:`RECORD_SPECTRA` is True, sets the interval at which to record a spectrum.</span>
    <span class="n">RECORD_SPECTRA_DT</span>      <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">RECORD_SPECTRA_DT</span>

    <span class="c1">#: Amount of time before tracking will timeout and the ground station return to idle. Must be larger than largest expected pass length.</span>
    <span class="n">MAX_TRACK_DT</span>           <span class="o">=</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">MAX_TRACK_DT</span>

    <span class="c1">#############################################</span>
    <span class="c1">#</span>
    <span class="c1"># Interface methods</span>
    <span class="c1">#</span>
    <span class="c1">#############################################</span>



<div class="viewcode-block" id="GroundStation.set_rangerate"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStation.set_rangerate.html#libgs.groundstation.GroundStation.set_rangerate">[docs]</a>    <span class="k">def</span> <span class="nf">set_rangerate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">range_rate</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">_set_rangerate_and_wait</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span> <span class="n">range_rate</span><span class="p">):</span>

            <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

            <span class="k">while</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">radio</span><span class="o">.</span><span class="n">range_rate</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">range_rate</span><span class="p">)):</span>
                <span class="n">radio</span><span class="o">.</span><span class="n">range_rate</span> <span class="o">=</span> <span class="n">range_rate</span>
                <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">t0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>

                <span class="n">safe_sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

            <span class="k">return</span> <span class="kc">True</span>

        <span class="n">succeeded</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radios</span><span class="p">:</span>

            <span class="c1"># if not r.controllable(&quot;range_rate&quot;):</span>
            <span class="c1">#     log.debugv(&quot;range_rate on radio %s is not currently controllable&quot;%(r.name))</span>
            <span class="c1">#     continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># dont change rate if already correct</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">range_rate</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">range_rate</span><span class="p">):</span>
                    <span class="n">succeeded</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
               <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Error reading range_rate: </span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>            


            <span class="c1"># Set range rate otherwise</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">_set_rangerate_and_wait</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">range_rate</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Timeout while trying to set range_rate on radio </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

                <span class="n">succeeded</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Failed to set range_rate for radio </span><span class="si">%s</span><span class="s2">. Error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">succeeded</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">debugv</span><span class="p">(</span><span class="s2">&quot;Could not set range_rate on any radio&quot;</span><span class="p">)</span></div>

        <span class="c1">#log.info(&quot;Range rate set to %d m/s&quot;%(range_rate))</span>


    <span class="c1"># TODO: deal with this wait. MAybe reomve? It conflicts wit conf.timeouts</span>
<div class="viewcode-block" id="GroundStation.transmit"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStation.transmit.html#libgs.groundstation.GroundStation.transmit">[docs]</a>    <span class="k">def</span> <span class="nf">transmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">Defaults</span><span class="o">.</span><span class="n">TX_REPLY_TIMEOUT</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Msg to transmit must be of type bytearray&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;transmit requested, but no protocol has been assigned.&quot;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">send_bytes</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_comms</span><span class="p">(</span><span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="s2">&quot;FAILURE: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">raise</span>
            
        <span class="n">logmsg</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%02X</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">]</span><span class="c1">#map(ord, msg)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_comms</span><span class="p">(</span><span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logmsg</span><span class="p">))</span></div>
            

<div class="viewcode-block" id="GroundStation.do_action"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStation.do_action.html#libgs.groundstation.GroundStation.do_action">[docs]</a>    <span class="k">def</span> <span class="nf">do_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_log_comms</span><span class="p">(</span><span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="s2">&quot;Protocol&quot;</span><span class="p">,</span> <span class="s2">&quot;`</span><span class="si">%s</span><span class="s2">`&lt;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">&gt;&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;do_action requested, but protocol not connected&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="n">do_action</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="GroundStation.track"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStation.track.html#libgs.groundstation.GroundStation.track">[docs]</a>    <span class="k">def</span> <span class="nf">track</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nid_or_pdata</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Track satellite by Norad ID or by specifying an az/el schedule as in :class:`libgs_ops.scheduling`</span>

<span class="sd">            The tracking is done by moving in steps across the trajectory of the satellite</span>

<span class="sd">            If specified by setting compute_ant_points to True, two things will happen:</span>
<span class="sd">            </span>
<span class="sd">              1. If the provided schedule does not have enough time resolution, it will be interpolated appropriately.</span>
<span class="sd">              2. The tracking will not be for every point in the schedule, but instead based on the antenna </span>
<span class="sd">                 beamwidth by calling :meth:`.hardware.RotatorBase.azel_to_antenna_angles` for each rotator.</span>
<span class="sd">              </span>

<span class="sd">            Doing so means the tracking happens as follows: If x0 is the actual satellite position at time t0:</span>

<span class="sd">                1. point to x0 + 1/2 beamwidth,</span>
<span class="sd">                2. wait until x0 - 1/2 beamwidth</span>
<span class="sd">                3. move to x0 + 1/2 beamwidth again ... etc</span>

<span class="sd">            </span>
<span class="sd">            Args:</span>
<span class="sd">                nid (int) or schedule (pdata) : Either the Norad ID or the schedule to track.</span>
<span class="sd">                  If Norad ID is provided and a propagator connected, then the</span>
<span class="sd">                  method will compute the pdata itself.                </span>
<span class="sd">                nid_or_pdata (int/DataFrame) : Either a schedule file (pdata) or a norad ID to track.</span>
<span class="sd">                rotators (list (:class:`~.hardware.RotatorBase`), optional): The list of rotators to track with. If not specified use :attr:`.rotators`.</span>
<span class="sd">                min_el (float, optional): The minimum permitted elevation angle. If not specified used the highest :attr:`~.hardware.RotatorBase.MIN_EL` of</span>
<span class="sd">                  the connected rotators. </span>
<span class="sd">                compute_ant_points (bool) : If true, do not follow every point in schedule but recompute</span>

<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="c1">#</span>
        <span class="c1"># Get pass data and Norad ID depending on what is provided in arguments</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nid_or_pdata</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="c1"># compute pdata</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Cannot compute pass data; no propagator has been connected&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pdat</span><span class="p">,</span> <span class="n">psum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="n">compute_pass</span><span class="p">(</span><span class="n">nid_or_pdata</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computed upcoming pass for NID </span><span class="si">%d</span><span class="s2"> to track: </span><span class="se">\n</span><span class="s2"> &quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nid_or_pdata</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">psum</span><span class="p">[[</span><span class="s1">&#39;tstamp_str&#39;</span><span class="p">,</span> <span class="s1">&#39;az&#39;</span><span class="p">,</span> <span class="s1">&#39;el&#39;</span><span class="p">]])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">    &#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pdat</span> <span class="o">=</span> <span class="n">nid_or_pdata</span>
            
            
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pdat</span><span class="p">,</span> <span class="s1">&#39;nid&#39;</span><span class="p">):</span>
            <span class="n">nid</span> <span class="o">=</span> <span class="n">pdat</span><span class="o">.</span><span class="n">nid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nid</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="n">nid_lbl</span> <span class="o">=</span> <span class="n">nid</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> 
            <span class="n">nid</span> <span class="o">=</span> <span class="kc">None</span>

            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rotators</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;rotators&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rotators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span>
            
        <span class="c1"># Check that the rotators are  connected</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rotators</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;No rotator connected to ground station - &quot;tracking&quot; with a dummy&#39;</span><span class="p">)</span>
            <span class="n">rotators</span> <span class="o">=</span> <span class="p">[</span><span class="n">DummyRotator</span><span class="p">()]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">compute_ant_points</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;compute_ant_points&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">compute_ant_points</span> <span class="o">=</span> <span class="kc">True</span>
            
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_el</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;min_el&#39;</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">min_el</span> <span class="o">=</span> <span class="n">rotators</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">MIN_EL</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rotators</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">MIN_EL</span> <span class="o">&gt;</span> <span class="n">min_el</span><span class="p">:</span>
                    <span class="n">min_el</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">MIN_EL</span>
                    
        <span class="c1">#</span>
        <span class="c1"># Check that tracking is not already in progress</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">IDLE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Ground station is already tracking, abort current track first&quot;</span><span class="p">)</span>

        <span class="c1">#</span>
        <span class="c1"># Reset stop flag</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_track</span><span class="o">=</span> <span class="kc">False</span>


        <span class="n">pass_stats</span> <span class="o">=</span> <span class="p">{}</span>


        <span class="c1">#</span>
        <span class="c1"># Pass ID, for tracking communications</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="si">%05d</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">nid_lbl</span><span class="p">),</span>
                              <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">pdat</span><span class="o">.</span><span class="n">tstamp_str</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">))</span>

        <span class="c1">#</span>
        <span class="c1"># Increase monitoring rate for duration of pass</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_monitor_pass</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="c1">#</span>
        <span class="c1"># Crop pass data to only include data above the visibility horizon</span>
        <span class="c1">#</span>
        <span class="n">pdat</span> <span class="o">=</span> <span class="n">pdat</span><span class="p">[</span><span class="n">pdat</span><span class="o">.</span><span class="n">el</span> <span class="o">&gt;=</span> <span class="n">min_el</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">pdat</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Pass does not ever become visible. Cannot track&quot;</span><span class="p">)</span>




        <span class="c1"># Save tracking data to state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pdat</span> <span class="o">=</span> <span class="n">pdat</span>



        <span class="n">s0</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># If we know which satellite we are tracking then</span>
            <span class="c1"># update state with its current position</span>
            <span class="c1">#</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">nid</span> <span class="o">=</span> <span class="n">nid</span>

            <span class="c1">#</span>
            <span class="c1"># Get current satellite position</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="n">get_angles</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
    
                <span class="n">s0</span> <span class="o">=</span> <span class="s1">&#39;Tracking </span><span class="si">%05d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s0</span><span class="p">)</span>




        <span class="c1">#</span>
        <span class="c1"># A small helper function to get current UTC time in pyephem format</span>
        <span class="c1">#</span>
        <span class="n">now</span> <span class="o">=</span> <span class="k">lambda</span> <span class="p">:</span> <span class="n">ephem</span><span class="o">.</span><span class="n">Date</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>


        <span class="k">def</span> <span class="nf">set_rangerate</span><span class="p">(</span><span class="n">rate</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">set_rangerate</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Error in set_rangerate: </span><span class="si">{0}</span><span class="s2"> : </span><span class="si">{1!r}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>


        <span class="c1">#</span>
        <span class="c1"># Calculate antenna pointings to use during track</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">compute_ant_points</span><span class="p">:</span>

            <span class="c1"># require a 1 second time resolution and allow 10% margin, or otherwise interpolate</span>
            <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">MAX_TRACK_DT</span><span class="o">*</span><span class="mf">1.1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Track does not have fine enough resolution, interpolating to dt=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MAX_TRACK_DT</span><span class="p">))</span>
                <span class="n">t_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">))</span>
                <span class="n">az_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_i</span><span class="p">,</span> <span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pdat</span><span class="o">.</span><span class="n">az</span><span class="p">)</span>
                <span class="n">el_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_i</span><span class="p">,</span> <span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pdat</span><span class="o">.</span><span class="n">el</span><span class="p">)</span>
                <span class="n">rr_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">t_i</span><span class="p">,</span> <span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pdat</span><span class="o">.</span><span class="n">range_rate</span><span class="p">)</span>
                <span class="n">pdat</span> <span class="o">=</span> <span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">t_i</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">az</span><span class="o">=</span><span class="n">az_i</span><span class="p">,</span> <span class="n">el</span><span class="o">=</span><span class="n">el_i</span><span class="p">,</span> <span class="n">range_rate</span><span class="o">=</span><span class="n">rr_i</span><span class="p">))</span>


            <span class="n">antangs</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">azel_to_antenna_angles</span><span class="p">(</span><span class="n">pdat</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rotators</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This option tracks schedule directly. Should really never be</span>
            <span class="c1"># done unless you specify a very sparse schedule manually</span>
            <span class="n">antangs</span> <span class="o">=</span> <span class="p">[</span><span class="n">pdat</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rotators</span><span class="p">]</span>


        <span class="c1"># find next pointing (may not be the first if track has started)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_point</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">antangs</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;Pass is entirely in the past. Cannot track (</span><span class="si">%s</span><span class="s2">)&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>



        <span class="n">pass_stats</span><span class="p">[</span><span class="s1">&#39;start_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>

        <span class="c1">#</span>
        <span class="c1"># Slew to start of track</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">SLEWING</span>

        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Slewing to start of track&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># TODO: incorporate messages in state? not sure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">track_msg</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">s</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">aa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">antangs</span><span class="p">):</span>
            <span class="n">rotators</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_azel</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">first_point</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">.</span><span class="n">az</span><span class="p">,</span> <span class="n">aa</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">first_point</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">.</span><span class="n">el</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


        <span class="c1">#</span>
        <span class="c1"># 2) Wait for satellite to come into view</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">WAITING</span>
        <span class="n">s</span><span class="o">=</span><span class="s2">&quot;Waiting for satellite to become visible&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">track_msg</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">s</span>

        <span class="k">while</span> <span class="p">(</span><span class="n">now</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_track</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="n">get_angles</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Satellite is currently not visible (az=</span><span class="si">%5.2f</span><span class="s1">, el=</span><span class="si">%5.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">track_msg</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">s</span>


            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>


        <span class="c1">#</span>
        <span class="c1"># Start recording radio</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD_SPECTRA</span><span class="p">:</span>
            <span class="n">radio_recordings</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">record_spectrum</span><span class="p">(</span><span class="n">dt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD_SPECTRA_DT</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">RECORD_SPECTRA_MAX_LEN</span><span class="p">,</span> <span class="n">fdec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">add_zeroes</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radios</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radio_recordings</span> <span class="o">=</span> <span class="p">[]</span>


        <span class="c1">#</span>
        <span class="c1"># 3) Track satellite</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">TRACKING</span>
        <span class="n">cur_point</span> <span class="o">=</span> <span class="n">first_point</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">aa</span><span class="p">)</span> <span class="k">for</span> <span class="n">aa</span> <span class="ow">in</span> <span class="n">antangs</span><span class="p">]</span>


        <span class="n">pass_stats</span><span class="p">[</span><span class="s1">&#39;start_track_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>
        <span class="n">pass_stats</span><span class="p">[</span><span class="s1">&#39;max_el&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now tracking&quot;</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">now</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">pdat</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_track</span><span class="p">:</span>
            

            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">aa</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">antangs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cur_point</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">num_points</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">now</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">aa</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">cur_point</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]):</span>
                    <span class="n">cur_point</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">new_el</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">cur_point</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">.</span><span class="n">el</span>
                    <span class="n">rotators</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_azel</span><span class="p">(</span><span class="n">aa</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">cur_point</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span><span class="o">.</span><span class="n">az</span><span class="p">,</span> <span class="n">new_el</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                    <span class="n">new_el_adj</span> <span class="o">=</span> <span class="mi">180</span> <span class="o">-</span> <span class="n">new_el</span> <span class="k">if</span> <span class="n">new_el</span> <span class="o">&gt;</span> <span class="mi">90</span> <span class="k">else</span> <span class="n">new_el</span>
    
                    <span class="k">if</span> <span class="n">pass_stats</span><span class="p">[</span><span class="s1">&#39;max_el&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">new_el_adj</span><span class="p">:</span>
                        <span class="n">pass_stats</span><span class="p">[</span><span class="s1">&#39;max_el&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_el_adj</span>

            <span class="c1"># It&#39;s not ideal to do this continuously, but since the radio might</span>
            <span class="c1"># reboot at any time it is important to keep the range rate updated</span>
            <span class="c1"># Note that: set_rangerate does not actually set the variable if it hasnt changed, however</span>
            <span class="c1"># It *does* issue an xmlrpc call to check if it has been set.</span>


            <span class="n">range_rate</span> <span class="o">=</span> <span class="n">pdat</span><span class="o">.</span><span class="n">range_rate</span><span class="p">[</span><span class="n">pdat</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">()]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_rate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">range_rate</span> <span class="o">=</span> <span class="n">pdat</span><span class="o">.</span><span class="n">range_rate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">range_rate</span> <span class="o">=</span> <span class="n">range_rate</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">set_rangerate</span><span class="p">(</span><span class="n">range_rate</span><span class="p">)</span>


            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Tracking&quot;</span>
            <span class="k">if</span> <span class="n">nid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Tracking satellite at (az=</span><span class="si">%5.2f</span><span class="s1">, el=</span><span class="si">%5.2f</span><span class="s1">)&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="n">get_angles</span><span class="p">(</span><span class="n">nid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cur_az</span> <span class="o">=</span> <span class="n">pdat</span><span class="o">.</span><span class="n">az</span><span class="p">[</span><span class="n">pdat</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">()]</span>
                <span class="n">cur_el</span> <span class="o">=</span> <span class="n">pdat</span><span class="o">.</span><span class="n">el</span><span class="p">[</span><span class="n">pdat</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">()]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_az</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_el</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span> <span class="o">=</span> <span class="p">(</span><span class="n">cur_az</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cur_el</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Tracking (az=</span><span class="si">%5.2f</span><span class="s1">, el=</span><span class="si">%5.2f</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">track_msg</span> <span class="o">=</span> <span class="n">s0</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">s</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>

        <span class="c1"># Mark the time of the end of track</span>
        <span class="n">pass_stats</span><span class="p">[</span><span class="s1">&#39;end_track_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>

        <span class="c1"># Move the yellow dot (satellite position) out of the way so we dont see it on plot</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Hiding satellite position. Current marked position: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">satpos</span><span class="p">))</span>


        <span class="c1">#</span>
        <span class="c1"># Stop recording</span>
        <span class="c1">#</span>
        <span class="k">for</span> <span class="n">radrec</span> <span class="ow">in</span> <span class="n">radio_recordings</span><span class="p">:</span>
            <span class="n">radrec</span><span class="o">.</span><span class="n">abort</span><span class="p">()</span>
            

        <span class="c1">#</span>
        <span class="c1"># 4) Stow antenna</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">SLEWING</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Stowing antenna&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">track_msg</span> <span class="o">=</span> <span class="n">s</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stow</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#TODO: Should it be true or false? I.e. do we want it to wait until antennas are stowed or not</span>

        <span class="n">pass_stats</span><span class="p">[</span><span class="s1">&#39;stowed_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">now</span><span class="p">()</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Track stats pass </span><span class="si">%s</span><span class="s2"> / </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_passlog</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pass_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;norad_id&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">pass_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">conv_time</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="s1">&#39;iso&#39;</span><span class="p">,</span> <span class="n">ignore_ambig_types</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_passlog</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pass_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">    </span><span class="si">%15s</span><span class="s2"> = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
    
    
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECORD_SPECTRA</span><span class="p">:</span>
                <span class="n">image_data</span> <span class="o">=</span> <span class="n">_mpl_make_waterfall_jpg</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">radios</span><span class="p">],</span> <span class="n">radio_recordings</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_passlog</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">pass_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;waterfall_jpeg&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">image_data</span><span class="p">)</span>
        
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Exception saving pass stats to db&quot;</span><span class="p">)</span>


        <span class="c1">#</span>
        <span class="c1"># 5) Return to idle</span>
        <span class="c1">#</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Antenna/Rotator state is idle&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">track_msg</span> <span class="o">=</span> <span class="n">s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">IDLE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span> <span class="o">=</span> <span class="kc">None</span>
        
        


        <span class="c1">#</span>
        <span class="c1"># Reduce monitoring save interval again</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_monitor_pass</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span></div>
        
 

    <span class="c1">#########################################################</span>
    <span class="c1">#</span>
    <span class="c1"># Non-interface private methods</span>
    <span class="c1">#</span>
    <span class="c1">########################################################        </span>



    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>        
                <span class="bp">self</span><span class="p">,</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">propagator</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">protocols</span>  <span class="o">=</span> <span class="p">[],</span>
                <span class="n">radios</span>     <span class="o">=</span> <span class="p">[],</span>
                <span class="n">rotators</span>   <span class="o">=</span> <span class="p">[],</span>
                <span class="n">commslog</span>   <span class="o">=</span> <span class="n">CommsLog</span><span class="p">(),</span>
                <span class="n">passlog</span>    <span class="o">=</span> <span class="n">PassDb</span><span class="p">(),</span>
                <span class="n">monlog</span>     <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">rpcserver</span>  <span class="o">=</span> <span class="kc">None</span>
            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        .. note::</span>
<span class="sd">            propagator, protocols, radios, rotators, rpcserver can also be set via their properties. The databases have to be specified</span>
<span class="sd">            in this constructor.</span>

<span class="sd">        Args:</span>
<span class="sd">            name (str):                                                             Descriptive name of the ground station</span>
<span class="sd">            propagator (:class:`~libgs_ops.propagator.Propagator`, optional):       A propagator to allow tracking by Norad ID</span>
<span class="sd">            protocols (:class:`~.protocols.protocolbase.ProtocolBase`, optional):   List of protocols to make available to ground station</span>
<span class="sd">            radios (:class:`~.hardware.RadioBase`, optional):                       List of radios to make available to ground station</span>
<span class="sd">            rotators (:class:`~.hardware.RotatorBase`, optional):                   List of rotators to make available to ground station   </span>
<span class="sd">            commslog (:class:`~.database.CommsLog`, optional):                      A database to use for storing communications. If omitted</span>
<span class="sd">                                                                                    an sqlite file in local direcotry will be used.</span>
<span class="sd">            passlog (:class:`~.database.PassDb`, optional):                         A database to use for storing information</span>
<span class="sd">                                                                                    about passes during a track. If omitted an sqlite file in local direcotry will be used.</span>
<span class="sd">            monlog (:class:`~.database.MonitorDb`, optional):                       A database to use for storing monitoring data. If omitted no data is stored.</span>
<span class="sd">            rpcserver (:class:`~.rpc.RPCServer`, optional):                         If an rpcserver is specified, it will be possible to control the</span>
<span class="sd">                                                                                    Ground Station remotely via XMLRPC.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initialise state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span>         <span class="o">=</span> <span class="n">GSState</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">name</span>    <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">state</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">IDLE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># initialise connected hardware</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span>    <span class="o">=</span> <span class="n">propagator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span>      <span class="o">=</span> <span class="n">rotators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radios</span>         <span class="o">=</span> <span class="n">radios</span>

        <span class="c1"># initialise protocols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span>     <span class="o">=</span> <span class="n">protocols</span>


        <span class="c1"># connect handlers</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="p">:</span>

            <span class="c1"># Set the handler for received messages</span>
            <span class="n">p</span><span class="o">.</span><span class="n">set_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">receive</span><span class="p">)</span>

        <span class="c1"># assign first protocol (note this also connects the receive handler)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span>      <span class="o">=</span> <span class="n">protocols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">protocols</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># initialise RPC interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpcserver</span>     <span class="o">=</span> <span class="n">rpcserver</span>


        <span class="c1">#</span>
        <span class="c1"># Communications database</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commslog</span> <span class="o">=</span> <span class="n">commslog</span>
        
        <span class="c1">#</span>
        <span class="c1"># Pass database</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_passlog</span> <span class="o">=</span> <span class="n">passlog</span>

        <span class="c1">#</span>
        <span class="c1"># Monitoring database</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monlog</span> <span class="o">=</span> <span class="n">monlog</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_monitor_pass</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_last_t</span> <span class="o">=</span> <span class="p">{}</span>
        

        <span class="c1"># Power up everything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">power_up</span><span class="p">()</span>


        <span class="c1">#</span>
        <span class="c1"># Initialise flags</span>
        <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_track</span> <span class="o">=</span> <span class="kc">False</span>


        <span class="c1">#</span>
        <span class="c1"># Start regular polling of antenna positions.</span>
        <span class="c1">#</span>
        <span class="k">def</span> <span class="nf">update_pos</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">curpos</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">get_azel</span><span class="p">()</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">cmdpos</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="o">.</span><span class="n">cmd_az</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">cmd_el</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">]</span>


        <span class="k">if</span> <span class="n">rotators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos_poller</span> <span class="o">=</span> <span class="n">RegularCallback</span><span class="p">(</span><span class="n">update_pos</span><span class="p">,</span> <span class="n">Defaults</span><span class="o">.</span><span class="n">GS_ROTATOR_POLLING_INTERVAL</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pos_poller</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>


        

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: Clean up - keep state stuff in state class</span>
        <span class="n">s</span> <span class="o">=</span>  <span class="s2">&quot;Ground Station </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">+=</span>  <span class="s2">&quot;  Propagator     : &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;not connected&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">propagator</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span>  <span class="s2">&quot;  Protocol       : &quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;not connected&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocol</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">s</span> <span class="o">+=</span>  <span class="s2">&quot;  Protocols avail: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">protocols</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radios</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Radios         : not connected</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">radios</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Radio[</span><span class="si">{:2}</span><span class="s2">]      : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span> 

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Rotators       : not connected</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotators</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;  Rotator[</span><span class="si">{:2}</span><span class="s2">]    : </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="fm">__str__</span><span class="p">())</span> 

        <span class="k">return</span> <span class="n">s</span>



    <span class="k">def</span> <span class="nf">_monitor_logger_cb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">tstamp</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitor callback that saves monitor data to database</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Ensure a minimum interval of  self._monitor_logger_dt happens before logging</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_last_t</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_dt</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_last_t</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_last_t</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monlog</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="s1">&#39;ERROR </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
                <span class="n">alert</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">alertstr</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">val</span>
                <span class="n">alert</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">alertstr</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;pass_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pass_id</span> <span class="o">=</span> <span class="s1">&#39;no pass&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pass_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># TODO: Decide if we want alert string or alert code in database</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_monlog</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pass_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">alert</span><span class="o">=</span><span class="n">alert</span><span class="p">)</span>




    <span class="k">def</span> <span class="nf">_set_monitor_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">passing</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Just a convenience function to update the interval at which _save_monitor_data is invoked for monitor data</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">passing</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MONITOR_SAVE_DT_TRACK</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_logger_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MONITOR_SAVE_DT_NOTRACK</span>


    <span class="k">def</span> <span class="nf">_log_comms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span> <span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Add communication to log</span>

<span class="sd">            .. todo::</span>
<span class="sd">               Streamline how this is done. Should be saved to a sql database</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;pass_id&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pass_id</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pass_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">pass_id</span>

        <span class="c1"># save message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_commslog</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pass_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pass_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">orig</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

   
   
   <span class="c1">################################################</span>
   <span class="c1">#</span>
   <span class="c1"># Non-interface public methods</span>
   <span class="c1">#</span>
   <span class="c1">###############################################</span>



    <span class="c1">#:</span>
    <span class="c1">#: Log entry for failed communication</span>
    <span class="c1">#:    </span>
    <span class="n">FAILED_COMMUNICATION</span> <span class="o">=</span> <span class="s1">&#39;Communication failed&#39;</span>


<div class="viewcode-block" id="GroundStation.set_schedule_msg"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStation.set_schedule_msg.html#libgs.groundstation.GroundStation.set_schedule_msg">[docs]</a>    <span class="k">def</span> <span class="nf">set_schedule_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interface method to set the :attr:`GSState.schedule` attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">schedule</span> <span class="o">=</span> <span class="n">msg</span></div>


<div class="viewcode-block" id="GroundStation.receive"><a class="viewcode-back" href="../../_autosummary/libgs.groundstation.GroundStation.receive.html#libgs.groundstation.GroundStation.receive">[docs]</a>    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Callback that is invoked whenever data is received. See :meth:`.protocols.protocolbase.ProtocolBase.set_handler`.</span>

<span class="sd">        It ensures communications are logged in the associated :class:`~.database.CommsLog`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>



        <span class="k">if</span> <span class="n">msg</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;FAILURE&#39;</span><span class="p">:</span>
            <span class="n">logmsg</span> <span class="o">=</span><span class="p">[</span><span class="s2">&quot;</span><span class="si">%02X</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">]</span><span class="c1"># map(ord, msg)]</span>
            <span class="n">logmsg</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">logmsg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_comms</span><span class="p">(</span><span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="n">logmsg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#</span>
            <span class="c1"># TODO: Record more details on comms failures by allowing</span>
            <span class="c1">#  FAILURE: &lt;some message&gt; to be sent from the protocol</span>
            <span class="c1">#</span>
            <span class="n">logmsg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">FAILED_COMMUNICATION</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_comms</span><span class="p">(</span> <span class="s2">&quot;Protocol&quot;</span><span class="p">,</span> <span class="s2">&quot;GS&quot;</span><span class="p">,</span> <span class="n">logmsg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">last_response</span> <span class="o">=</span> <span class="n">logmsg</span></div></div>








<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>

</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, UNSW

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>